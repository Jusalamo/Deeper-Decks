<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deeper-Decks™: The Card Game</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22url(%23rainbow)%22>D</text><defs><linearGradient id=%22rainbow%22 gradientTransform=%22rotate(90)%22><stop offset=%220%25%22 stop-color=%22%23FF1F40%22/><stop offset=%2225%25%22 stop-color=%22%23FF8BA4%22/><stop offset=%2250%25%22 stop-color=%22%2348BB78%22/><stop offset=%2275%25%22 stop-color=%22%236F38E0%22/><stop offset=%22100%25%22 stop-color=%22%23FF1F40%22/></linearGradient></defs></svg>" type="image/svg+xml">
    <meta name="description" content="Deeper-Decks™ is a card game with intimate, naughty, platonic, and girls' night questions and dares for deep connection.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/mona-sans" rel="stylesheet">
    <style>
        :root {
            --color-romantic: #FF1F40;
            --color-platonic: #48BB78;
            --color-naughty: #6F38E0;
            --color-girls: #FF8BA4;
            --bg-light: #FAFAFA;
            --surface-light: #F0F0F0;
            --modal-dark: #2A2A2A;
            --card-white: #FFFFFF;
            --text-dark: #1A1A1A;
            --text-light: #FFFFFF;
            --shadow-subtle: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            --shadow-card: 0 20px 50px rgba(0,0,0,0.1);
            --shadow-stack: 0 10px 30px rgba(0,0,0,0.15), 0 4px 10px rgba(0,0,0,0.1);
            --color-white: hsl(0,0%,100%);
            --color-cyan: hsl(180,100%,50%);
            --color-blue: hsl(240,100%,50%);
            --color-purple: hsl(270,100%,50%);
            --color-pink: hsl(330,40%,70%);
            --color-red: hsl(0,100%,50%);
            --color-yellow: hsl(60,100%,50%);
            --color-lime: hsl(90,100%,75%);
        }
        body { background-color: var(--bg-light); font-family: 'Inter', sans-serif; color: var(--text-dark); margin: 0; padding: 0; overflow-x: hidden; transition: background-color 0.3s ease, color 0.3s ease; }

        /* SIDEBAR */
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; backdrop-filter: blur(4px); }
        .sidebar-overlay.active { opacity: 1; visibility: visible; }
        .sidebar-menu { position: fixed; top: 0; right: -100%; width: 320px; height: 100%; background: var(--modal-dark); z-index: 3001; transition: right 0.4s cubic-bezier(0.4,0,0.2,1); padding: 24px; overflow-y: auto; box-shadow: -5px 0 30px rgba(0,0,0,0.3); }
        .sidebar-menu.active { right: 0; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-title { font-size: 1.5rem; font-weight: 700; color: var(--text-light); font-family: 'Mona Sans', sans-serif; }
        .close-sidebar { background: none; border: none; color: var(--text-light); font-size: 1.5rem; cursor: pointer; padding: 8px; border-radius: 8px; transition: background-color 0.2s; }
        .close-sidebar:hover { background-color: rgba(255,255,255,0.1); }
        .sidebar-item { display: flex; align-items: center; gap: 12px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s ease; color: var(--text-light); border: none; width: 100%; text-align: left; font-size: 1rem; font-weight: 500; }
        .sidebar-item:hover { background: rgba(255,255,255,0.1); transform: translateX(-2px); }

        /* HAMBURGER */
        .hamburger-menu { position: fixed; top: 20px; right: 20px; z-index: 2000; background: var(--modal-dark); border: none; border-radius: 12px; width: 48px; height: 48px; display: none; flex-direction: column; justify-content: center; align-items: center; gap: 6px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .hamburger-menu:hover { transform: scale(1.05); }
        .hamburger-line { width: 20px; height: 2px; background: var(--text-light); border-radius: 2px; transition: all 0.3s ease; }
        .hamburger-menu.active .hamburger-line:nth-child(1) { transform: rotate(45deg) translate(6px,6px); }
        .hamburger-menu.active .hamburger-line:nth-child(2) { opacity: 0; }
        .hamburger-menu.active .hamburger-line:nth-child(3) { transform: rotate(-45deg) translate(6px,-6px); }

        /* ── FIX 1: INTRO + PROGRESS BAR ───────────────────────────────────────── */
        #introScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 4000; transition: opacity 0.6s ease-out; }
        .rainbow-logo {
            font-family: 'Mona Sans', sans-serif; font-size: 3rem; font-weight: 900;
            /* Use background-position instead of @property so all browsers animate it */
            background: linear-gradient(to right, var(--color-white), var(--color-white), var(--color-cyan), var(--color-blue), var(--color-purple), var(--color-pink), var(--color-red), var(--color-yellow), var(--color-lime), var(--color-white), var(--color-white)) no-repeat 100% 0% / 900%;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            letter-spacing: -1px; margin-bottom: 1rem;
            animation: rainbowSlide 2s ease-in-out forwards;
        }
        @keyframes rainbowSlide { from { background-position: 100% 0%; } to { background-position: 0% 0%; } }
        .intro-subtitle { font-size: 1.125rem; color: rgba(255,255,255,0.7); font-weight: 400; letter-spacing: 0.5px; margin-bottom: 3rem; opacity: 0; animation: fadeInUp 0.8s ease-out 0.8s forwards; }
        .rainbow-progress { width: 200px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden; opacity: 0; animation: fadeIn 0.4s ease-out 0.5s forwards; }
        /* FIX 1: longer transition + start fully rendered so reflow trick works */
        .rainbow-progress-bar { width: 0%; height: 100%; background: linear-gradient(to right, var(--color-cyan), var(--color-blue), var(--color-purple), var(--color-pink), var(--color-red), var(--color-yellow), var(--color-lime)); border-radius: 3px; transition: width 1.8s cubic-bezier(0.28,0.11,0.32,1); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* MAIN GAME */
        #mainGame { display: none; opacity: 0; transition: opacity 0.5s ease-in; padding: 1rem; width: 100%; min-height: 100vh; }

        /* CARD STACK */
        .card-stack-container { aspect-ratio: 9/14; width: 350px; max-width: 90vw; position: relative; }
        .card-stack-shadow { position: absolute; width: 100%; height: 100%; top: 10px; left: 0; border-radius: 20px; box-shadow: var(--shadow-stack); z-index: -2; opacity: 0.4; }
        .card-front { background-color: var(--card-white); color: var(--text-dark); border-radius: 20px; box-shadow: var(--shadow-card); transition: transform 0.4s cubic-bezier(0.175,0.885,0.32,1.275), opacity 0.3s ease; position: absolute; width: 100%; height: 100%; top: 0; left: 0; will-change: transform, opacity; border: 1px solid rgba(0,0,0,0.05); cursor: pointer; user-select: none; -webkit-user-select: none; }
        .card-back { background: linear-gradient(135deg,#2A2A2A 0%,#1F1F1F 100%); border-radius: 20px; box-shadow: var(--shadow-card); position: absolute; width: 98%; height: 98%; top: 1%; left: 1%; z-index: -1; border: 1px solid rgba(255,255,255,0.05); }
        .card-slide-out-left  { transform: translateX(-150%) rotate(-15deg) !important; opacity: 0 !important; }
        .card-slide-out-right { transform: translateX(150%)  rotate(15deg)  !important; opacity: 0 !important; }
        .empty-card { border: 3px dashed var(--text-dark); background-color: var(--card-white); }
        .card-content-area { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .card-question-text { font-size: clamp(1.2rem,5vw,2.1rem); line-height: 1.3; font-weight: 700; text-shadow: 0 0 1px rgba(0,0,0,0.1); }
        .card-header-chip { border-radius: 9999px; padding: 6px 14px; font-weight: 600; font-size: 0.85rem; opacity: 0.95; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .player-badge { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 999px; font-weight: 600; font-size: 0.9rem; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-content { background: var(--modal-dark); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 32px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); color: var(--text-light); }
        .deck-modal-content { max-width: 600px; }
        .deck-option { background: rgba(255,255,255,0.05); border: 2px solid transparent; border-radius: 16px; padding: 20px; margin-bottom: 15px; cursor: pointer; transition: all 0.3s ease; }
        .deck-option:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
        .deck-option.active { border-color: currentColor; background: rgba(255,255,255,0.15); }
        .player-input { background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 12px 16px; color: var(--text-light); font-size: 1rem; transition: border-color 0.2s; }
        .player-input:focus { outline: none; border-color: rgba(255,255,255,0.4); }
        .player-item { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; color: var(--text-light); }
        .btn-remove { background: rgba(255,107,129,0.2); color: var(--color-romantic); border-radius: 8px; padding: 6px 12px; font-size: 0.875rem; transition: all 0.2s; border: none; cursor: pointer; }
        .btn-remove:hover { background: rgba(255,107,129,0.3); }

        /* CONTROL PANEL */
        .control-panel { background: var(--surface-light); border: 1px solid rgba(0,0,0,0.1); border-radius: 20px; padding: 24px; box-shadow: var(--shadow-subtle); align-self: flex-start; color: var(--text-dark); }
        .btn-action { background-color: var(--modal-dark); color: var(--text-light); border-radius: 14px; padding: 16px 24px; font-weight: 700; transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s; box-shadow: 0 4px 0 rgba(0,0,0,0.2); border: none; cursor: pointer; }
        .btn-action:hover:not(:disabled) { background-color: #3A3A3A; transform: translateY(-2px); box-shadow: 0 6px 0 rgba(0,0,0,0.2); }
        .btn-action:disabled { opacity: 0.4; cursor: not-allowed; transform: translateY(0); box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        .btn-shuffle { background-color: var(--surface-light); color: var(--text-dark); border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 4px 0 rgba(0,0,0,0.05); margin-top: 1rem; }
        .btn-shuffle:hover:not(:disabled) { background-color: #E0E0E0; transform: translateY(-2px); box-shadow: 0 6px 0 rgba(0,0,0,0.05); }
        .counter-box { background-color: var(--surface-light); border: 1px solid rgba(0,0,0,0.08); box-shadow: var(--shadow-subtle); }
        .settings-option { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); color: var(--text-light); }
        .shuffling { animation: shuffle 0.5s ease-in-out; }
        @keyframes shuffle { 0%{transform:rotate(0deg) scale(1);} 25%{transform:rotate(-5deg) scale(1.02);} 50%{transform:rotate(5deg) scale(1.02);} 75%{transform:rotate(-2deg) scale(1.01);} 100%{transform:rotate(0deg) scale(1);} }
        .swipe-instruction { text-align: center; margin-top: 20px; color: rgba(0,0,0,0.5); font-size: 0.9rem; }

        /* DARK MODE */
        body.dark-mode { background-color: #121212; color: #FFFFFF !important; }
        body.dark-mode .text-gray-900, body.dark-mode .text-gray-800, body.dark-mode .text-gray-700 { color: #FFFFFF !important; }
        body.dark-mode .text-gray-600, body.dark-mode .text-gray-500, body.dark-mode .text-gray-400 { color: #A0A0A0 !important; }
        body.dark-mode .control-panel, body.dark-mode .counter-box { background-color: #1F1F1F; color: #FFFFFF; border-color: rgba(255,255,255,0.1); }
        body.dark-mode .card-front { background-color: #2A2A2A; color: #FFFFFF; border-color: rgba(255,255,255,0.1); }
        body.dark-mode .swipe-instruction { color: rgba(255,255,255,0.5); }
        body.dark-mode .btn-shuffle { background-color: #2A2A2A; color: #FFFFFF; border-color: rgba(255,255,255,0.1); }
        body.dark-mode .btn-shuffle:hover:not(:disabled) { background-color: #3A3A3A; }
        body.dark-mode .empty-card { border-color: #FFFFFF; background-color: #2A2A2A; color: #FFFFFF; }

        @media (max-width: 1024px) {
            main { flex-direction: column-reverse; }
            .control-panel { width: 100%; margin-top: 2rem; }
            header { margin-top: 1rem; }
            .rainbow-logo { font-size: 2.5rem; }
            .intro-subtitle { font-size: 1rem; }
            .sidebar-menu { width: 280px; }
        }
        .swipe-zone { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        .game-title, .modal-title, .sidebar-title { font-family: 'Mona Sans', sans-serif !important; font-weight: 900 !important; letter-spacing: -1px; }
        h1, h2, h3 { font-family: 'Mona Sans', sans-serif !important; font-weight: 900 !important; }
    </style>
</head>
<body>
    <button id="hamburgerButton" class="hamburger-menu">
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
    </button>

    <div id="sidebarOverlay" class="sidebar-overlay"></div>
    <div id="sidebarMenu" class="sidebar-menu">
        <div class="sidebar-header">
            <h3 class="sidebar-title">Menu</h3>
            <button id="closeSidebar" class="close-sidebar"><i data-lucide="x"></i></button>
        </div>
        <button id="sidebarManagePlayers" class="sidebar-item"><i data-lucide="users"></i> Manage Players</button>
        <button id="sidebarChangeDeck"    class="sidebar-item"><i data-lucide="layers"></i> Change Deck</button>
        <button id="sidebarSettings"      class="sidebar-item"><i data-lucide="settings"></i> Settings</button>
        <div class="mt-8 pt-6 border-t border-gray-800">
            <div class="text-center text-gray-400 text-sm">
                <p>Deeper-Decks™</p>
                <p class="mt-1">The Card Game for Real Connection</p>
            </div>
        </div>
    </div>

    <!-- INTRO SCREEN -->
    <div id="introScreen">
        <header class="max-w-xl w-full text-center mb-6 px-4 sm:px-0">
            <h1 class="rainbow-logo">Deeper-Decks™</h1>
            <div class="intro-subtitle">The Card Game for Real Connection</div>
        </header>
        <div class="rainbow-progress">
            <div class="rainbow-progress-bar" id="rainbowProgressBar"></div>
        </div>
    </div>

    <!-- PLAYER MODAL -->
    <div id="playerModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2 class="text-3xl font-bold text-white mb-2 text-center game-title">Deeper-Decks™</h2>
            <p class="text-gray-400 text-center mb-6">Add players to get started</p>
            <div class="mb-6">
                <div class="flex gap-2 mb-4">
                    <input type="text" id="playerNameInput" class="player-input flex-1" placeholder="Enter player name" maxlength="20" />
                    <button id="addPlayerBtn" class="btn-action px-6">Add</button>
                </div>
                <div id="playersList" class="space-y-2 mb-4"></div>
                <p class="text-sm text-gray-400 text-center mb-4"><span id="playerCount">0</span> players added (minimum 2)</p>
            </div>
            <button id="startGameBtn" class="btn-action w-full text-lg py-3" disabled>Choose Deck &amp; Start Playing</button>
        </div>
    </div>

    <!-- DECK MODAL -->
    <div id="deckModal" class="modal-overlay" style="display:none;">
        <div class="modal-content deck-modal-content">
            <h2 class="text-3xl font-bold text-white mb-2 text-center game-title">Choose Your Deck</h2>
            <p class="text-gray-400 text-center mb-6">Select a deck to start playing</p>
            <div id="deckOptions" class="space-y-3">
                <div class="deck-option" data-deck="romantic" style="color:var(--color-romantic);">
                    <div class="flex items-center gap-3"><i data-lucide="heart" class="w-6 h-6"></i><div><h3 class="text-xl font-bold">Romantic Deck</h3><p class="text-gray-400 text-sm">90 cards for couples and dates</p></div></div>
                </div>
                <div class="deck-option" data-deck="platonic" style="color:var(--color-platonic);">
                    <div class="flex items-center gap-3"><i data-lucide="handshake" class="w-6 h-6"></i><div><h3 class="text-xl font-bold">Platonic Deck</h3><p class="text-gray-400 text-sm">90 cards for friends and hangouts</p></div></div>
                </div>
                <div class="deck-option" data-deck="girlsnight" style="color:var(--color-girls);">
                    <div class="flex items-center gap-3"><i data-lucide="users-2" class="w-6 h-6"></i><div><h3 class="text-xl font-bold">Girls' Night Deck</h3><p class="text-gray-400 text-sm">90 cards for girls' nights out</p></div></div>
                </div>
                <div class="deck-option" data-deck="naughty" style="color:var(--color-naughty);">
                    <div class="flex items-center gap-3"><i data-lucide="flame" class="w-6 h-6"></i><div><h3 class="text-xl font-bold">Naughty Deck</h3><p class="text-gray-400 text-sm">90 cards for spicy conversations</p></div></div>
                </div>
            </div>
            <button id="confirmDeckBtn" class="btn-action w-full text-lg py-3 mt-6" disabled>Start Playing with Selected Deck</button>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2 class="text-3xl font-bold text-white mb-6 text-center game-title">Settings</h2>
            <div class="space-y-4">
                <div class="settings-option"><span>Theme</span><select id="themeSelect" class="player-input"><option value="light">Light Mode</option><option value="dark">Dark Mode</option></select></div>
                <div class="settings-option"><span>Card Animation Speed</span><select id="animationSpeed" class="player-input"><option value="fast">Fast</option><option value="normal" selected>Normal</option><option value="slow">Slow</option></select></div>
                <div class="settings-option"><span>Swipe Sensitivity</span><select id="swipeSensitivity" class="player-input"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></div>
            </div>
            <button id="closeSettingsBtn" class="btn-action w-full text-lg py-3 mt-6">Save &amp; Close</button>
        </div>
    </div>

    <!-- MAIN GAME -->
    <div id="mainGame" class="min-h-screen flex flex-col items-center">
        <header class="max-w-xl w-full text-center mb-6 mt-4 px-4 sm:px-0">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-900 mb-2 tracking-tight game-title">Deeper-Decks<sup class="text-xl ml-1 align-top">&trade;</sup></h1>
            <p class="text-gray-600 text-lg font-medium">The Card Game for Real Connection</p>
        </header>
        <main class="w-full max-w-6xl flex flex-col lg:flex-row gap-8 px-4 sm:px-6">
            <section class="lg:w-1/3 control-panel h-full flex flex-col justify-start order-2 lg:order-1">
                <h2 class="text-2xl font-bold mb-6 text-gray-900" id="deckTitle">Select a Deck</h2>
                <div class="mb-8">
                    <div class="text-center p-5 rounded-xl counter-box mb-6">
                        <p class="text-base font-semibold text-gray-600">Cards Remaining</p>
                        <p id="remainingCount" class="text-5xl font-extrabold text-gray-900 tracking-wider mt-1">90</p>
                    </div>
                    <button id="drawButton" class="btn-action py-4 px-12 text-xl font-bold tracking-wide uppercase w-full mb-3">Draw Next Card</button>
                    <button id="shuffleButton" class="w-full btn-action btn-shuffle"><i data-lucide="rotate-ccw" class="w-5 h-5 inline mr-2"></i> Re-Shuffle Current Deck</button>
                </div>
            </section>
            <section class="lg:w-2/3 flex flex-col items-center order-1 lg:order-2">
                <div id="cardContainer" class="relative flex-shrink-0 mb-8 card-stack-container">
                    <div class="card-stack-shadow"></div>
                </div>
                <div class="swipe-instruction"><i data-lucide="move-horizontal" class="w-5 h-5 inline mr-2"></i> Swipe left/right to draw next card</div>
            </section>
        </main>
    </div>

    <!-- MODULE: Firebase + Lucide icons only -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, increment, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { createIcons, Heart, Flame, Users, Handshake, Star, RotateCcw, Zap, Users2, Lightbulb, User, Layers, Settings, MoveHorizontal, X } from 'https://unpkg.com/lucide@latest/dist/esm/lucide.js';

        // ── FIX 2: expose createIcons IMMEDIATELY (not inside DOMContentLoaded)
        // so the regular script can call it as soon as icons are needed.
        window.createIcons = () => createIcons({ icons: { Heart, Flame, Users, Handshake, Star, RotateCcw, Zap, Users2, Lightbulb, User, Layers, Settings, MoveHorizontal, X } });

        let db;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const COUNTER_DOC_PATH = `/artifacts/${appId}/public/data/counters/visitor_count`;

        async function initFirebase() {
            if (!Object.keys(firebaseConfig).length) return;
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                await new Promise(res => {
                    onAuthStateChanged(auth, async user => {
                        if (!user) {
                            if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                            else await signInAnonymously(auth);
                            onAuthStateChanged(auth, u => { if (u) res(); });
                        } else res();
                    });
                });
                // Listener
                onSnapshot(doc(db, COUNTER_DOC_PATH), snap => {
                    const el = document.getElementById('visitorCount');
                    if (el) el.textContent = snap.exists() ? snap.data().count.toLocaleString() : '0';
                });
                // Track visit
                const KEY = 'deeper_decks_visited_v4';
                if (sessionStorage.getItem(KEY) !== 'true') {
                    const ref = doc(db, COUNTER_DOC_PATH);
                    const snap = await getDoc(ref);
                    if (snap.exists()) await updateDoc(ref, { count: increment(1) });
                    else await setDoc(ref, { count: 1 });
                    sessionStorage.setItem(KEY, 'true');
                }
            } catch (e) { console.error('Firebase error:', e); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initFirebase, 500);
        });
    </script>

    <!-- REGULAR SCRIPT: all game logic -->
    <script>
        // ── DECK DATA ─────────────────────────────────────────────────────────────
        const romanticQuestions = [
            "What's your idea of the perfect date night that we haven't tried yet?",
            "What's one thing you're working toward right now that excites you?",
            "What's a hidden talent or hobby of yours that not many people know about?",
            "If you could travel anywhere in the world together, where would you want to go and why?",
            "What's your love language, and how do you like to receive affection?",
            "What's something small I do that always makes you smile?",
            "What's a childhood memory that shaped who you are today?",
            "What does your ideal weekend look like?",
            "What's one thing on your bucket list you're determined to accomplish?",
            "How do you like to be comforted when you're having a bad day?",
            "What's your favorite way to spend quality time together?",
            "What's something you've always wanted to learn or try?",
            "What's a tradition from your family that you'd want to carry forward?",
            "What makes you feel most appreciated in a relationship?",
            "What's your biggest dream for the next five years?",
            "What's something that instantly puts you in a good mood?",
            "How do you know when you're truly comfortable with someone?",
            "What's a value or belief that's really important to you?",
            "What's your favorite memory of us so far?",
            "What's something you're really proud of yourself for?",
            "What does partnership mean to you?",
            "What's a song or movie that always makes you emotional?",
            "What's your favorite thing about the stage of life you're in right now?",
            "What's something I could do to support your goals better?",
            "What's a random act of kindness that really stuck with you?",
            "How do you like to celebrate your wins, big or small?",
            "What's something you're passionate about that you could talk about for hours?",
            "What's your favorite season and what do you love about it?",
            "What makes you feel most connected to someone?",
            "What's a quality you really admire in other people?",
            "What's one thing about yourself that you feel I truly understand?",
            "What moment made you realize you wanted to get to know me better?",
            "What's a fear you have about relationships, and where does it come from?",
            "How has your past shaped what you're looking for in a relationship?",
            "What's something you've learned about yourself through being with me?",
            "What does 'home' mean to you?",
            "What's a habit of mine that you've grown to love?",
            "What do you think makes us work well together?",
            "What's the biggest lesson you've learned from a past relationship?",
            "What's one thing you hope we never stop doing together?",
            "How do you want to grow in the next year, personally?",
            "What's your favorite inside joke or moment we share?",
            "What makes you feel most loved by me?",
            "What's a quality I have that you didn't expect?",
            "What do you think our biggest strength as a couple is?",
            "What's something vulnerable you've shared with me that felt scary?",
            "What's one goal you have for us as a couple?",
            "How do you handle conflict in relationships?",
            "What's a small gesture I could do more often that would mean a lot?",
            "What's your favorite thing about the way we communicate?",
            "DARE: Close your eyes and describe what you love most about the way I make you feel.",
            "DARE: Share the first thought you had when you saw me today.",
            "DARE: Tell me three things you're grateful for about our relationship right now.",
            "DARE: Describe your favorite memory with me in detail.",
            "DARE: Give me a compliment you've been thinking but haven't said out loud yet.",
            "DARE: Share a song that reminds you of me and explain why.",
            "DARE: Tell me something you've noticed about me that I might not realize.",
            "DARE: Describe what your perfect day together would look like from start to finish.",
            "DARE: Share a goal you have and how I can support you in achieving it.",
            "DARE: Tell me one thing you want to do together that we've never done.",
            "DARE: Give me a 30-second shoulder massage while telling me what you appreciate about me.",
            "DARE: Share something that made you smile today and why.",
            "DARE: Look into my eyes for 30 seconds without saying anything, then describe what you felt.",
            "DARE: Tell me about a moment when you felt most proud of me.",
            "DARE: Share your favorite thing about my personality.",
            "DARE: Describe the exact moment you knew you had feelings for me.",
            "DARE: Tell me one thing you want me to know but have been afraid to say.",
            "DARE: Share a dream you have for our future.",
            "DARE: Give me three reasons why you think we're a good match.",
            "DARE: Tell me about a time I surprised you in a good way.",
            "DARE: Share what attracted you to me when we first met.",
            "DARE: Describe how I make you feel safe.",
            "DARE: Tell me one thing you've always wanted to do with me.",
            "DARE: Share your favorite physical feature of mine and why.",
            "DARE: Describe a moment when you felt most connected to me.",
            "DARE: Tell me what you think makes our relationship special.",
            "DARE: Share one thing you want to work on together as a couple.",
            "DARE: Describe your ideal date that you'd plan for me.",
            "DARE: Tell me about a time when I made you feel truly heard.",
            "DARE: Share what you think our relationship will look like in 5 years.",
            "DARE: Give me a compliment about something other than my appearance.",
            "DARE: Tell me about a fear you have and how I can help you through it.",
            "DARE: Share your favorite way I show you love.",
            "DARE: Describe a quality of mine that you hope to develop in yourself.",
            "DARE: Tell me about a time when I exceeded your expectations.",
            "DARE: Share what you think is the most romantic thing I've done for you.",
            "DARE: Describe how your life has changed since we got together.",
            "DARE: Tell me one thing you appreciate about how I treat others.",
            "DARE: Share a sacrifice you'd be willing to make for our relationship.",
            "DARE: Describe the moment you realized I was someone special."
        ];

        const platonicQuestions = [
            "If you could only eat one food for the rest of your life, what would it be and why?",
            "What's the weirdest compliment you've ever received?",
            "If you were a kitchen appliance, which one would you be and why?",
            "What's your go-to karaoke song and how badly do you butcher it?",
            "What's the most embarrassing thing you've done in front of a crush?",
            "If your life had a theme song, what would it be?",
            "What's the strangest thing you believed as a child?",
            "What's your signature dance move when no one's watching?",
            "If you could swap lives with any celebrity for a day, who and why?",
            "What's the funniest text you've sent to the wrong person?",
            "What's your comfort show that you've binged way too many times?",
            "If you had to live in a reality TV show, which one would you choose?",
            "What's the most useless talent you have?",
            "What's your Starbucks order and what does it say about you?",
            "If you could have dinner with any three people dead or alive, who would they be?",
            "What's the pettiest thing you've done and are low-key proud of?",
            "What's your unpopular opinion that you'll defend to death?",
            "What's the worst haircut you've ever had?",
            "If you could be famous for something ridiculous, what would it be?",
            "What's your toxic trait that you refuse to change?",
            "What's the dumbest way you've injured yourself?",
            "If you were a meme, which one would you be?",
            "What's your most irrational fear?",
            "What's the most spontaneous thing you've ever done?",
            "If you could have any superpower but it had to be completely useless, what would it be?",
            "What's your guilty pleasure song that you blast when alone?",
            "What's the worst gift you've ever received?",
            "If your personality was a color, what would it be and why?",
            "What's the funniest rumor you've heard about yourself?",
            "What would your wrestling entrance song be?",
            "What's something you're embarrassingly bad at?",
            "If you could cancel one trend forever, what would it be?",
            "What's your most controversial food opinion?",
            "What's the weirdest phase you went through?",
            "If you had to get a tattoo right now, what would it be?",
            "What's your biggest ick in other people?",
            "What's the most cringe thing you did as a teenager?",
            "If you could bring back one discontinued product, what would it be?",
            "What's your go-to lie when you don't want to hang out?",
            "What's the most awkward situation you've ever been in?",
            "If you could live in any decade, which one and why?",
            "What's your biggest flex that no one knows about?",
            "What's the dumbest argument you've won?",
            "If you were arrested, what would your friends assume you did?",
            "What's your red flag in friendships?",
            "What's the worst advice you've ever given someone?",
            "If you could delete one app from existence, which would it be?",
            "What's your most used emoji and why?",
            "What's something you do that you think is normal but others find weird?",
            "If you had to live without one of your five senses, which would you give up?",
            "DARE: Show everyone your most embarrassing photo from your camera roll.",
            "DARE: Do your best impression of someone in the room right now.",
            "DARE: Freestyle rap about the person to your left for 20 seconds.",
            "DARE: Let someone else post anything they want on your story right now.",
            "DARE: Show your most recent Google search and explain it.",
            "DARE: Do a dramatic reading of the last text message you sent.",
            "DARE: Demonstrate your worst dance moves for 15 seconds.",
            "DARE: Let the group go through your liked videos on TikTok/Instagram.",
            "DARE: Call a random contact and say something completely absurd.",
            "DARE: Share your most played song this month and perform a snippet.",
            "DARE: Show your screen time report and let everyone judge you.",
            "DARE: Do your best celebrity impression right now.",
            "DARE: Let someone read your notes app out loud.",
            "DARE: Show the group your most recent Amazon purchase.",
            "DARE: Do a dramatic monologue about your biggest pet peeve.",
            "DARE: Let someone go through your photo gallery for 30 seconds.",
            "DARE: Show your top 3 most contacted people and explain why.",
            "DARE: Perform your best TikTok dance trend.",
            "DARE: Read your most recent text conversation out loud.",
            "DARE: Show everyone your lock screen and explain the story behind it.",
            "DARE: Do an impression of how you act when you're hangry.",
            "DARE: Let the group see your Spotify wrapped or most played playlist.",
            "DARE: Show your calculator history and explain what you were calculating.",
            "DARE: Demonstrate how you flirt with someone you like.",
            "DARE: Let someone make up a contact name for someone in your phone.",
            "DARE: Show your email inbox and let people judge your unread count.",
            "DARE: Do your signature pose for taking selfies.",
            "DARE: Share the weirdest thing in your saved Instagram posts.",
            "DARE: Let someone read your last 5 tweets or posts out loud.",
            "DARE: Show your YouTube search history from this week.",
            "DARE: Demonstrate your go-to facial expression when you're annoyed.",
            "DARE: Let the group rename your Wi-Fi network right now.",
            "DARE: Show everyone your phone's home screen and explain your organization.",
            "DARE: Do your best impression of yourself when you're drunk.",
            "DARE: Let someone scroll through your Twitter/X likes.",
            "DARE: Show your most used GIFs or stickers in messages.",
            "DARE: Demonstrate how you walk when you think you look cool.",
            "DARE: Let someone read your browser tabs out loud.",
            "DARE: Show your Venmo/CashApp transaction history from this month.",
            "DARE: Do an impression of yourself waking up in the morning."
        ];

        const girlsNightQuestions = [
            "Spill: What's the most embarrassing thing you've done to get a guy's attention?",
            "Who's your current situationship and what's the tea?",
            "What's the most unhinged text you've sent your crush at 2 AM?",
            "Rate your current partner/crush out of 10 and explain your rating.",
            "What's the craziest thing you've done on a girls' night out?",
            "Describe your worst date ever - don't hold back the details!",
            "What's your signature 'getting ready' routine song?",
            "Who in your friend group gives the worst dating advice?",
            "What's the pettiest thing you've done after a breakup?",
            "Share your most iconic 'revenge dress' moment.",
            "What's the biggest red flag you've ignored in a guy?",
            "Who's the one that got away and do you still think about them?",
            "What's your go-to 'cry playlist' and why?",
            "Describe the time you got the biggest ick from someone you were dating.",
            "What's the most dramatic thing you've done over a guy who wasn't worth it?",
            "Share your best 'hot girl walk' playlist song.",
            "What's the worst pickup line someone has tried on you?",
            "Who's your guilty pleasure celebrity crush?",
            "What's the most embarrassing thing in your search history right now?",
            "Describe your dream wedding in three words.",
            "What's the shadiest thing another girl has done to you?",
            "Share your most toxic trait in relationships.",
            "What's your signature perfume and what vibe does it give?",
            "Who's your fictional character crush and why?",
            "What's the most money you've spent on looking good for one night?",
            "Describe the outfit that makes you feel most confident.",
            "What's your go-to move when you want to soft launch someone on IG?",
            "Share the worst thing an ex has said to you.",
            "What's your comfort romcom that you've watched 100 times?",
            "Who's your girl crush and what do you love about her?",
            "What's the most embarrassing thing you've posted and deleted immediately?",
            "Describe your ideal 'that girl' morning routine.",
            "What's the biggest lie you've told on a dating app?",
            "Share your most controversial beauty opinion.",
            "What's the most desperate thing you've done to see your crush's story?",
            "Who's the friend you call first when drama happens?",
            "What's your signature going out outfit vibe?",
            "Describe the time you knew a friendship was over.",
            "What's your toxic trait when it comes to texting?",
            "Share the most cringe TikTok you've made.",
            "What's the meanest thing you thought but didn't say?",
            "Describe your dream honeymoon destination.",
            "What's your biggest dating app pet peeve?",
            "Share the most dramatic thing you've done for the perfect selfie.",
            "What's the worst thing you've done while tipsy on a night out?",
            "Who's your style icon and why?",
            "What's the most embarrassing thing you've done in front of your crush?",
            "Describe your signature makeup look.",
            "What's the pettiest reason you've stopped talking to someone?",
            "Share your most embarrassing autocorrect fail to your crush.",
            "DARE: Make a TikTok right now recreating a trending sound about your dating life.",
            "DARE: Text your crush something flirty and read their response out loud.",
            "DARE: Show everyone the last five guys in your Instagram DMs and explain the context.",
            "DARE: Do a runway walk across the room in your best 'just saw my ex' strut.",
            "DARE: Create a fake dating app profile bio for the person next to you.",
            "DARE: Show the group your 'For You' page and let them judge you.",
            "DARE: Dramatically read the last text your ex sent you.",
            "DARE: Give everyone a makeover tip based on their vibe.",
            "DARE: Post a thirst trap on your story right now and screenshot the first three responses.",
            "DARE: Recreate your go-to selfie pose and let everyone rate it out of 10.",
            "DARE: Show everyone your Pinterest board and let them roast you.",
            "DARE: Text someone 'we need to talk' and show the responses.",
            "DARE: Do a makeup tutorial using only words, no demonstrating.",
            "DARE: Show the group your camera roll from last weekend.",
            "DARE: Create a 15-second get-ready-with-me TikTok right now.",
            "DARE: Let someone read your group chat messages from today.",
            "DARE: Show everyone your saved Instagram posts.",
            "DARE: Do your best influencer voice promoting a random object in the room.",
            "DARE: Share your Amazon shopping cart and let everyone judge.",
            "DARE: Show your Spotify daylist and explain yourself.",
            "DARE: Let someone write a caption for your next Instagram post.",
            "DARE: Show everyone your dating app matches right now.",
            "DARE: Do your best impression of yourself when you're flirting.",
            "DARE: Show the group your recent voice memos.",
            "DARE: Let someone look at your BeReal from today.",
            "DARE: Share your VSCO or photo editing app and show your presets.",
            "DARE: Show everyone your Snapchat best friends list.",
            "DARE: Do your signature pose for mirror selfies.",
            "DARE: Let the group see your YouTube watch history from this week.",
            "DARE: Show your Shein/online shopping orders from this month.",
            "DARE: Demonstrate your go-to drunk girl in the bathroom pose.",
            "DARE: Show everyone your skincare routine products and explain them.",
            "DARE: Let someone go through your TikTok favorites.",
            "DARE: Share your Notes app to-do list or random notes.",
            "DARE: Show your phone's widget screen and explain your choices.",
            "DARE: Do your best 'main character moment' walk and pose.",
            "DARE: Let someone read your Goodreads or book app reviews.",
            "DARE: Show the group your Depop/Poshmark likes or purchases.",
            "DARE: Demonstrate how you pose when someone says 'act natural' for a photo.",
            "DARE: Share your wellness or cycle tracking app and current mood."
        ];

        const naughtyQuestions = [
            "Who in this room do you think is secretly the most dominant in bed?",
            "Point to someone in this room: What's the first dirty thought you had about them tonight?",
            "Who in this room looks like they give the best head? Explain your reasoning.",
            "If you had to sleep with two people in this room at the same time, who would it be and why?",
            "Who in this room do you think has the biggest dick/biggest ass? Don't hold back.",
            "Look around the room: Who do you think is into getting choked?",
            "Who in this room would you most want to watch you masturbate?",
            "Point to someone: What position would you want them to put you in first?",
            "Who in this room do you think has the dirtiest porn search history?",
            "If you could have anyone in this room go down on you right now, who would it be?",
            "Who in this room do you think screams the loudest during sex?",
            "Who here would you let tie you up, and what would you want them to do?",
            "Which person in this room would you most want to receive a lap dance from?",
            "Who in this room looks like they're into anal? Be honest.",
            "Point to someone in this room you'd let fuck you in the bathroom right now.",
            "Who here do you think has the highest body count and why?",
            "Who in this room would you want to have a threesome with your partner?",
            "Who here looks like they can last the longest in bed?",
            "Point to someone: describe exactly what you'd do to them if the lights went out.",
            "Who in this room would you most want to have angry, aggressive sex with?",
            "Who here do you think is the biggest freak when the doors close?",
            "If you had to fuck, marry, or kill three people in this room, who would they be?",
            "Who in this room would you let record you during sex?",
            "Point to someone who you think gives the nastiest dirty talk.",
            "Who here would you want to have a one-night stand with, no strings attached?",
            "Who in this room do you think has sent the most nudes?",
            "Look around: who would you let finish on your face?",
            "Who here looks like they're into role-playing in the bedroom?",
            "Point to someone you'd want to make out with aggressively right now.",
            "Who in this room do you think has the prettiest moans?",
            "Who here would you want to dominate you completely?",
            "If you could watch anyone in this room have sex, who would it be?",
            "Who in this room would you let use toys on you?",
            "Point to someone who you think fucks on the first date.",
            "Who here do you think has the wettest pussy/hardest dick right now?",
            "Who in this room would you want to wake up to going down on you?",
            "Look around: who would you let spank you until you cry?",
            "Who here looks like they swallow?",
            "Point to someone you'd want to sit on your face immediately.",
            "Who in this room would you want to pin you against the wall?",
            "Who here do you think has tried the kinkiest shit?",
            "If you had to let someone in this room walk in on you naked, who would you choose?",
            "Who in this room would you want to share a shower with?",
            "Point to someone who you think could make you cum the fastest.",
            "Who here would you want to have rough, primal sex with?",
            "Who in this room looks like they eat ass?",
            "If you could only fuck one person in this room for the rest of your life, who?",
            "Who here would you let control your orgasms for a week?",
            "Point to someone in this room whose nudes you'd most want to see.",
            "Who here do you think has the best stroke game?",
            "DARE: Point to someone in this room and tell them exactly what you'd do to them if you were alone together.",
            "DARE: Choose someone in this room to give you a sensual 30-second neck or shoulder massage.",
            "DARE: Pick someone in this room and whisper the dirtiest thing you've thought about them tonight.",
            "DARE: Stand up and demonstrate on someone how you like to be kissed.",
            "DARE: Choose someone to sit on your lap for the next two rounds.",
            "DARE: Pick someone in this room and describe their moans based on vibes alone.",
            "DARE: Choose someone and trace your finger along their collarbone while maintaining eye contact.",
            "DARE: Point to someone and tell them which position you'd put them in first.",
            "DARE: Pick two people in this room and explain why they'd be your perfect threesome.",
            "DARE: Choose someone to blindfold you and feed you something sensually.",
            "DARE: Select someone in the room and tell everyone what you think their body count is.",
            "DARE: Pick someone and demonstrate how you'd seduce them at a bar.",
            "DARE: Choose someone to exchange a piece of clothing with for the next 10 minutes.",
            "DARE: Point to someone and describe exactly where you'd want to kiss them first.",
            "DARE: Pick someone and tell them your most vivid sexual fantasy involving them - be specific.",
            "DARE: Choose someone to whisper in your ear what they'd do to you - then share it with the group.",
            "DARE: Select someone and maintain intense eye contact while you slowly lick your lips for 15 seconds.",
            "DARE: Pick someone in this room and describe what you think their 'O face' looks like.",
            "DARE: Choose someone to demonstrate your favorite make-out technique on (hand or similar).",
            "DARE: Point to someone and tell them the first body part of theirs you'd want to touch.",
            "DARE: Pick someone and tell them what you'd name your sex tape together.",
            "DARE: Choose someone to give you a body shot (simulated or real).",
            "DARE: Select someone and tell everyone what you think they're like in bed based on their energy.",
            "DARE: Pick someone and describe in detail the outfit you'd want to rip off them.",
            "DARE: Choose someone to feed you a piece of food as sensually as possible.",
            "DARE: Point to someone and confess what you've noticed about their body tonight.",
            "DARE: Pick someone and tell them the exact location on their body you'd leave a hickey.",
            "DARE: Choose someone to give you a lap dance for 20 seconds (or demonstrate the moves).",
            "DARE: Select someone and describe the sexual tension you feel between you two.",
            "DARE: Pick someone and tell them what toy you'd use on them.",
            "DARE: Choose someone to sit between your legs for the next round.",
            "DARE: Point to someone and describe how you'd dominate or submit to them.",
            "DARE: Pick someone and tell them exactly what underwear you think they're wearing.",
            "DARE: Choose someone to slow dance with you for 30 seconds, as close as possible.",
            "DARE: Select someone and whisper something that would make them blush immediately.",
            "DARE: Pick someone and rate their fuck-ability out of 10, then explain your rating.",
            "DARE: Choose someone to bite your lip gently while making eye contact.",
            "DARE: Point to someone and tell them what role they'd play in your ideal orgy.",
            "DARE: Pick someone and demonstrate how you'd grind on them at a club.",
            "DARE: Choose someone and confess the first dirty thought you had when you met them."
        ];

        // ── GAME STATE ────────────────────────────────────────────────────────────
        let currentDeck = [], remainingCardsCount = 0, deckType = '';
        let players = [], currentPlayerIndex = 0, selectedDeckForModal = '';
        let isSwiping = false, swipeStartX = 0, swipeStartY = 0, swipeThreshold = 50;

        const DECK_PROPERTIES = {
            romantic:   { icon: 'heart',    title: 'Romantic Deck™',     colorVar: 'var(--color-romantic)' },
            platonic:   { icon: 'handshake', title: 'Platonic Deck™',    colorVar: 'var(--color-platonic)' },
            naughty:    { icon: 'flame',     title: 'Naughty Deck™',     colorVar: 'var(--color-naughty)'  },
            girlsnight: { icon: 'users-2',   title: "Girls' Night Deck™", colorVar: 'var(--color-girls)'   }
        };

        function getDeckQuestions(t) {
            return { romantic: romanticQuestions, platonic: platonicQuestions, naughty: naughtyQuestions, girlsnight: girlsNightQuestions }[t] || [];
        }
        function getDeckInfo(t) { return DECK_PROPERTIES[t] || {}; }
        function shuffleArray(a) {
            for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i+1)); [a[i],a[j]] = [a[j],a[i]]; }
            return a;
        }

        // ── PLAYERS ───────────────────────────────────────────────────────────────
        function addPlayer(name) {
            if (name && !players.includes(name)) { players.push(name); renderPlayers(); }
            document.getElementById('playerNameInput').value = '';
        }
        window.removePlayer = n => { players = players.filter(p => p !== n); renderPlayers(); };
        function renderPlayers() {
            document.getElementById('playersList').innerHTML = players.length === 0
                ? '<p class="text-gray-500 text-center py-4">No players added yet</p>'
                : players.map(p => `<div class="player-item"><span class="text-white font-medium">${p}</span><button class="btn-remove" onclick="removePlayer('${p}')">Remove</button></div>`).join('');
            document.getElementById('playerCount').textContent = players.length;
            document.getElementById('startGameBtn').disabled = players.length < 2;
        }
        function getCurrentPlayer() { return players.length ? players[currentPlayerIndex % players.length] : null; }
        function advancePlayer() { currentPlayerIndex++; }

        // ── MODALS ────────────────────────────────────────────────────────────────
        window.showPlayerModal   = () => { document.getElementById('playerModal').style.display = 'flex'; };
        window.hidePlayerModal   = () => { document.getElementById('playerModal').style.display = 'none'; };
        window.showDeckModal     = () => {
            document.getElementById('deckModal').style.display = 'flex';
            document.querySelectorAll('.deck-option').forEach(o => o.classList.remove('active'));
            document.getElementById('confirmDeckBtn').disabled = true;
            selectedDeckForModal = '';
        };
        window.hideDeckModal     = () => { document.getElementById('deckModal').style.display = 'none'; };
        window.showSettingsModal = () => { document.getElementById('settingsModal').style.display = 'flex'; };
        window.hideSettingsModal = () => { document.getElementById('settingsModal').style.display = 'none'; };

        // ── CARD RENDERING ────────────────────────────────────────────────────────
        function updateCardCount() {
            document.getElementById('remainingCount').textContent = remainingCardsCount;
            document.getElementById('drawButton').disabled = remainingCardsCount === 0;
        }
        function getCardBackHtml() {
            const c = getDeckInfo(deckType).colorVar || '#888';
            return `<div class="card-back flex items-center justify-center p-6 z-0"><div class="text-center opacity-70"><i data-lucide="lightbulb" class="w-10 h-10 mx-auto mb-3" style="color:${c};"></i><h3 class="text-2xl font-bold text-white game-title">Deeper-Decks</h3><p class="text-sm font-medium mt-1 text-gray-400">The Card Game</p></div></div>`;
        }
        function createCardElement(question) {
            const isDare = question.startsWith("DARE:");
            const content = isDare ? question.substring(5).trim() : question;
            const info = getDeckInfo(deckType);
            const cardNumber = 90 - currentDeck.length;
            const player = getCurrentPlayer();
            return `<div class="card-front flex flex-col justify-between p-8 sm:p-12 w-full h-full text-center z-10">
                <div class="flex justify-between items-center mb-4">
                    <span class="font-light text-base opacity-70">#${cardNumber}/90</span>
                    <div class="card-header-chip text-white" style="background-color:${info.colorVar};"><i data-lucide="${isDare?'zap':info.icon}" class="w-4 h-4 inline -mt-0.5 mr-1"></i>${isDare?'DARE':'QUESTION'}</div>
                </div>
                ${player ? `<div class="flex justify-center mb-4"><div class="player-badge" style="background-color:${info.colorVar};"><i data-lucide="user" class="w-4 h-4"></i><span>${player}</span></div></div>` : ''}
                <div class="card-content-area px-0 min-h-[140px]"><p class="card-question-text text-gray-900">${content}</p></div>
                <div class="text-xs text-right text-gray-500 mt-6 pt-3 border-t border-gray-100">${info.title}</div>
            </div>`;
        }
        function showEmptyDeckCard() {
            const cc = document.getElementById('cardContainer');
            cc.innerHTML = getCardBackHtml();
            cc.insertAdjacentHTML('beforeend', `<div class="empty-card card-front flex flex-col justify-center items-center p-6 text-center z-10"><i data-lucide="rotate-ccw" class="w-12 h-12 mb-4" style="color:${getDeckInfo(deckType).colorVar};"></i><p class="text-2xl font-bold text-gray-900">Deck Complete!</p><p class="text-lg text-gray-600 mt-2">Time to shuffle for a new round.</p></div>`);
            if (window.createIcons) window.createIcons();
        }

        // ── SWIPE ─────────────────────────────────────────────────────────────────
        function handleSwipe(sx, sy, ex, ey) {
            const dX = ex - sx;
            if (Math.abs(dX) > Math.abs(ey - sy) && Math.abs(dX) > swipeThreshold) {
                dX > 0 ? initializeDeck(deckType) : (!document.getElementById('drawButton').disabled && drawCard());
            }
        }
        function addSwipeZone() {
            const cc = document.getElementById('cardContainer');
            const card = cc.querySelector('.card-front');
            if (!card) return;
            const zone = document.createElement('div');
            zone.className = 'swipe-zone';
            const onStart = (x, y) => { isSwiping = true; swipeStartX = x; swipeStartY = y; };
            const onMove  = x => { if (isSwiping) { const d = x - swipeStartX; if (Math.abs(d) > 10) card.style.transform = `translateX(${d*.5}px) rotate(${d*.05}deg)`; } };
            const onEnd   = (x, y) => { if (!isSwiping) return; isSwiping = false; card.style.transform = ''; handleSwipe(swipeStartX, swipeStartY, x, y); };
            zone.addEventListener('touchstart',  e => { onStart(e.touches[0].clientX, e.touches[0].clientY); e.preventDefault(); }, { passive: false });
            zone.addEventListener('touchmove',   e => { onMove(e.touches[0].clientX); e.preventDefault(); }, { passive: false });
            zone.addEventListener('touchend',    e => { onEnd(e.changedTouches[0].clientX, e.changedTouches[0].clientY); e.preventDefault(); }, { passive: false });
            zone.addEventListener('mousedown',   e => { onStart(e.clientX, e.clientY); e.preventDefault(); });
            zone.addEventListener('mousemove',   e => { onMove(e.clientX); });
            zone.addEventListener('mouseup',     e => { onEnd(e.clientX, e.clientY); });
            zone.addEventListener('mouseleave',  () => { if (isSwiping) { isSwiping = false; card.style.transform = ''; } });
            cc.appendChild(zone);
        }

        // ── DRAW ──────────────────────────────────────────────────────────────────
        function drawCard() {
            const cc = document.getElementById('cardContainer');
            if (!currentDeck.length) { showEmptyDeckCard(); updateCardCount(); return; }
            const { question } = currentDeck.pop();
            remainingCardsCount = currentDeck.length;
            const old = cc.querySelector('.card-front, .empty-card');
            const next = createCardElement(question);
            if (old) {
                cc.querySelector('.swipe-zone')?.remove();
                old.classList.add('card-slide-out-right');
                setTimeout(() => { old.remove(); cc.insertAdjacentHTML('beforeend', next); addSwipeZone(); updateCardCount(); if (window.createIcons) window.createIcons(); if (players.length) advancePlayer(); }, 400);
            } else {
                cc.insertAdjacentHTML('beforeend', next); addSwipeZone(); updateCardCount(); if (window.createIcons) window.createIcons(); if (players.length) advancePlayer();
            }
        }

        // ── INITIALIZE DECK ───────────────────────────────────────────────────────
        function initializeDeck(type) {
            deckType = type.toLowerCase();
            const info = getDeckInfo(deckType);
            currentDeck = shuffleArray(getDeckQuestions(deckType).map((q, i) => ({ question: q, i })));
            remainingCardsCount = currentDeck.length;
            document.getElementById('deckTitle').textContent = info.title;
            const cc = document.getElementById('cardContainer');
            cc.classList.add('shuffling');
            cc.querySelector('.swipe-zone')?.remove();
            cc.innerHTML = getCardBackHtml();
            cc.insertAdjacentHTML('beforeend', `<div class="card-front flex flex-col justify-center items-center p-6 text-center z-10" style="background-color:${info.colorVar};"><div class="text-center text-white"><i data-lucide="star" class="w-10 h-10 mx-auto mb-4"></i><h3 class="text-3xl font-bold text-white">${info.title}</h3><p class="text-md font-medium mt-2 text-white">90 Cards Ready</p>${players.length ? `<p class="text-sm mt-2 opacity-90">${players.length} players joined</p>` : ''}</div></div>`);
            addSwipeZone(); updateCardCount();
            if (window.createIcons) window.createIcons();
            setTimeout(() => cc.classList.remove('shuffling'), 1000);
            hideDeckModal();
        }

        // ── DARK MODE ─────────────────────────────────────────────────────────────
        function applyDarkMode(on) {
            document.body.classList.toggle('dark-mode', on);
            document.body.style.backgroundColor = on ? '#121212' : '';
            document.body.style.color = on ? '#FFFFFF' : '';
        }

        // ── SIDEBAR ───────────────────────────────────────────────────────────────
        function initSidebar() {
            const btn = document.getElementById('hamburgerButton');
            const overlay = document.getElementById('sidebarOverlay');
            const menu = document.getElementById('sidebarMenu');
            btn.style.display = 'flex';
            const open  = () => { menu.classList.add('active'); overlay.classList.add('active'); btn.classList.add('active'); document.body.style.overflow = 'hidden'; };
            const close = () => { menu.classList.remove('active'); overlay.classList.remove('active'); btn.classList.remove('active'); document.body.style.overflow = ''; };
            btn.addEventListener('click', () => menu.classList.contains('active') ? close() : open());
            document.getElementById('closeSidebar').addEventListener('click', close);
            overlay.addEventListener('click', close);
            document.getElementById('sidebarManagePlayers').addEventListener('click', () => { close(); showPlayerModal(); });
            document.getElementById('sidebarChangeDeck').addEventListener('click',  () => { close(); showDeckModal(); });
            document.getElementById('sidebarSettings').addEventListener('click',    () => { close(); showSettingsModal(); });
        }

        // ── INTRO ─────────────────────────────────────────────────────────────────
        // FIX 1: force a reflow before setting width so the CSS transition fires.
        // FIX 2: called directly from DOMContentLoaded with no dependency on the module.
        function startIntro() {
            const bar = document.getElementById('rainbowProgressBar');
            // Reflow trick: reading any layout property forces the browser to commit
            // the current style (width:0), so the subsequent change to width:100%
            // is seen as an animated transition rather than an instant jump.
            bar.getBoundingClientRect();
            bar.style.width = '100%';

            setTimeout(() => {
                const intro = document.getElementById('introScreen');
                intro.style.opacity = '0';
                setTimeout(() => {
                    intro.style.display = 'none';
                    showPlayerModal();
                }, 600);
            }, 2300); // wait for bar animation (1.8s) + a little breathing room
        }

        // ── BOOT ──────────────────────────────────────────────────────────────────
        document.addEventListener('DOMContentLoaded', () => {
            initSidebar();

            // Player modal inputs
            document.getElementById('addPlayerBtn').addEventListener('click', () => {
                const v = document.getElementById('playerNameInput').value.trim(); if (v) addPlayer(v);
            });
            document.getElementById('playerNameInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') { const v = e.target.value.trim(); if (v) addPlayer(v); }
            });
            document.getElementById('startGameBtn').addEventListener('click', () => {
                if (players.length >= 2) { hidePlayerModal(); showDeckModal(); }
            });

            // Deck modal
            document.querySelectorAll('.deck-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    document.querySelectorAll('.deck-option').forEach(o => o.classList.remove('active'));
                    opt.classList.add('active');
                    selectedDeckForModal = opt.dataset.deck;
                    document.getElementById('confirmDeckBtn').disabled = false;
                });
            });
            document.getElementById('confirmDeckBtn').addEventListener('click', () => {
                if (!selectedDeckForModal) return;
                const mg = document.getElementById('mainGame');
                mg.style.display = 'block';
                setTimeout(() => { mg.style.opacity = '1'; initializeDeck(selectedDeckForModal); }, 50);
            });

            // Settings
            document.getElementById('closeSettingsBtn').addEventListener('click', () => {
                const s = document.getElementById('swipeSensitivity').value;
                swipeThreshold = s === 'low' ? 100 : s === 'high' ? 30 : 50;
                applyDarkMode(document.getElementById('themeSelect').value === 'dark');
                hideSettingsModal();
            });

            // Game buttons
            document.getElementById('drawButton').addEventListener('click', drawCard);
            document.getElementById('shuffleButton').addEventListener('click', () => initializeDeck(deckType));

            // Default players
            addPlayer('Player 1');
            addPlayer('Player 2');

            // Kick off the intro — no module dependency, always fires correctly
            startIntro();
        });
    </script>
</body>
</html>
